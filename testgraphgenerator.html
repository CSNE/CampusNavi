
<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">

    <style>
        #mapid {
            height: 480px;
        }
    </style>

    <!-- leaflet.js 불러오기 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin=""></script>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }

        #mapid {
            height: 50%;
        }

        #uipanel {
            display: flex;
            flex-flow: row;
            height: 30%;
        }

        .listcontainer
        {
            border: 1px solid black;
            display: inline-block;
            width: 50%;
            height: 100%;
        }
        .list
        {
            display: flex;
            flex-flow: column;
            height: 100%;
            overflow-y: scroll;
        }
        .listelement
        {
            display: block;
            border: 2px solid transparent;
        }
        .listelement.selected
        {
            border-color: red;
            background-color: yellow;
        }
        .newbutton
        {
            display: block;
            text-align: center;
            background-color: lightgrey;
            padding: 7px;
            margin: 4px;
        }
        .input
        {
            display: inline-block;
            vertical-align: bottom;
            height: 1em;
            padding: 2px;
            border: 1px solid blue;
            color: blue;
        }
        .label
        {
            display: inline-block;
            vertical-align: bottom;
            height: 1em;
            padding: 2px;
        }

        #json_string {
            width: 100%;
            height: 20%;
        }
    </style>

    <script>
        function List() {
            this.h = {};
            this.h.next = this.h;
            this.h.prev = this.h;
            this.h.isHeader = true;

            this.add = function (e) {
                var ret = { v: e, next: this.h, prev: this.h.prev };
                this.h.prev.next = ret;
                this.h.prev = ret;
                return ret;
            }

            this.remove = function (n)
            {
                if (n.prev && n.next)//static
                {
                    n.prev.next = n.next;
                    n.next.prev = n.prev;
                }
                else
                {
                    for (var i = this.iterator(); !i.end(); i.next())
                    {
                        if (i.get() == n)
                        {
                            i.remove();
                            break;
                        }
                    }
                }
            }

            function Iterator(l) {
                this.p = l.h.next;

                this.end = function () {
                    return this.p.isHeader;
                }

                this.next = function () {
                    this.p = this.p.next;
                }

                this.get = function () {
                    return this.p.v;
                }

                this.remove = function () {
                    this.p.prev.next = this.p.next;
                    this.p.next.prev = this.p.prev;
                }
            }

            this.iterator = function () {
                return new Iterator(this);
            }
        }

        var V = new List(), E = new List();

        function findVertexById(id)
        {
            for (var i = V.iterator(); !i.end(); i.next())
            {
                var v = i.get();
                if (v.id == id)
                    return v;
            }
            return null;
        }

        function update(o)
        {
            switch (o.type)
            {
                case "vertex":
                    updateVertex(o);
                    break;
                case "edge":
                    updateEdge(o);
                    break;
            }
        }

        function updateVertex(v)
        {
            v.layer.setLatLng(v.loc);
            v.layer.setTooltipContent("[" + v.id + "]: " + v.name);
            v.targetElement.input_id.innerHTML = v.id;
            v.targetElement.input_name.innerHTML = v.name;
            //update edges
            for (var i = v.edges.iterator(); !i.end(); i.next())
            {
                Log.debug(i.get().name);
                updateEdge(i.get());
            }
        }

        function setLocation(e, loc)
        {
            e.loc = loc;
            updateVertex(e);
        }

        function updateEdge(e)
        {
            e.layer.setLatLngs([e.vs ? e.vs.loc : getDefaultLocation(), e.ve ? e.ve.loc : getDefaultLocation()])
            e.targetElement.input_name.innerHTML = e.name;
            e.targetElement.input_vs.innerHTML = e.vs ? e.vs.id : "(null)";
            e.targetElement.input_ve.innerHTML = e.ve ? e.ve.id : "(null)";
            e.targetElement.input_w.innerHTML = JSON.stringify(e.w);
            e.targetElement.input_f.innerHTML = JSON.stringify(e.f);
        }

        var vertex_style_default =  { bubblingMouseEvents: false, pane: "vertices", radius: 12, stroke: false, fill: true, fillOpacity: 1, fillColor: "blue" };
        var vertex_style_selected = { bubblingMouseEvents: false, pane: "selected", radius: 12, stroke: true, weight: 4, color: "lime", fill: true, fillOpacity: 1, fillColor: "blue" };
        var edge_style_default =    { bubblingMouseEvents: false, pane: "edges", weight: 4, color: "red" };
        var edge_style_selected = { bubblingMouseEvents: false, pane: "selected", weight: 4, color: "lime" };

        function getCurrentJSON()
        {
            var obj = {
                vertices: [],
                edges: []
            };
            for (var i = V.iterator(); !i.end(); i.next())
            {
                var o = i.get();
                obj.vertices.push({ id: o.id, name: o.name, loc: o.loc });
            }
            for (var i = E.iterator(); !i.end(); i.next())
            {
                var o = i.get();
                obj.edges.push({ name: o.name, vs: o.vs.id, ve: o.ve.id, w: o.w, f: o.f });
            }
            return JSON.stringify(obj);
        }

        function loadData()
        {
            //Log.debug("loadData");
            var ret = null;
            //Log.debug(document.cookie);
            if (document.cookie)
            {
                var arr = document.cookie.split(";");
                for (var i = 0; i < arr.length; i++)
                {
                    var pair = arr[i].split("=");
                    //alert(pair);
                    switch (pair[0].trim()) {
                        case "data":
                            ret = pair[1].trim();
                            break;
                        case "vertex_id_counter":
                            //alert();
                            vertex_id_counter = parseInt(pair[1].trim());
                            break;
                    }
                }
            }
            return ret;
            //Log.info("no cookie");
        }

        function storeData(data)
        {
            //Log.debug("storeData");
            var date = new Date();
            date.setFullYear(date.getFullYear() + 1);
            //Log.debug(date.toUTCString());
            document.cookie = "data=" + data + ";" +
                "expires=" + date.toUTCString() + ";";
            //Log.debug(x);
            document.cookie = "vertex_id_counter=" + vertex_id_counter + ";" +
                "expires=" + date.toUTCString() + ";";
            //Log.debug(document.cookie);
        }

        function applyData(data)
        {
            var obj = JSON.parse(unescape(data));
            var vb = document.getElementById("vbtn");
            var eb = document.getElementById("ebtn");
            for (var i = 0; i < obj.vertices.length; i++)
            {
                var o = obj.vertices[i];
                create_new_vertex(vb, { id: o.id, name: o.name, loc: o.loc});
            }
            for (var i = 0; i < obj.edges.length; i++)
            {
                var o = obj.edges[i];
                create_new_edge(eb, { name: o.name, vs: findVertexById(o.vs), ve: findVertexById(o.ve), w: o.w, f: o.f });
            }
            document.getElementById("json_string").innerHTML = data;
        }

    </script>

</head>

<body>
    <!-- 지도 div -->
    <div id="mapid"></div>

    <script>
        var selected;
        var two_vertices = [null, null];

        function select(e)
        {
            if (e != selected/* && e.type == "vertex"*/)
            {
                if (selected)
                {
                    unselect[selected.type](selected);
                }
                select[e.type](e);
                selected = e;
            }
        }
        var unselect = {};

        function updateStyle(e)
        {
            e.removeFrom(mymap);
            e.addTo(mymap);
        }

        select["vertex"] = function (e) {
            e.targetElement.classList.add("selected");
            e.layer.setStyle(vertex_style_selected)
            ;//    .on(event_draggable_vertex);
            updateStyle(e.layer);
            two_vertices[1] = two_vertices[0];
            two_vertices[0] = e;
        }
        select["edge"] = function (e) {
            e.targetElement.classList.add("selected");
            e.layer.setStyle(edge_style_selected);
            updateStyle(e.layer);
        }
        unselect["vertex"] = function () {
            selected.targetElement.classList.remove("selected");
            selected.layer.setStyle(vertex_style_default)
            ;//    .off(event_draggable_vertex);
            updateStyle(selected.layer);
            selected = null;
        }
        unselect["edge"] = function () {
            selected.targetElement.classList.remove("selected");
            selected.layer.setStyle(edge_style_default);
            updateStyle(selected.layer);
            selected = null;
        }

        function removeObj(e)
        {
            if (selected == e)
                unselect[e.type](e);
            switch (e.type) {
                case "vertex":
                    l = V;
                    for (var i = 0, j = 0; i < 2; i++) {
                        if (two_vertices[i] == e) {
                            j++;
                        }
                        two_vertices[i] = i + j < 2 ? two_vertices[i + j] : null;
                    }
                    for (var i = e.edges.iterator(); !i.end(); i.next())
                    {
                        removeObj(i.get());
                    }
                    break;
                case "edge":
                    l = E;
                    if (e.vs)
                        e.vs.edges.remove(e);
                    if (e.ve)
                        e.ve.edges.remove(e);
                    break;
                default:
                    return;
            }
            l.remove(e.node);
            //alert(e.targetElement.classList);
            e.targetElement.parentNode.removeChild(e.targetElement);
            mymap.removeLayer(e.layer);
        }
        
        function element_click(e)
        {
            var s = e.target;
            while (!s.targetObj)
                s = s.parentNode;
            select(s.targetObj);
        }
        function element_dblclick(e)
        {
            var s = e.target;
            while (!s.targetObj)
                s = s.parentNode;
            var l;
            removeObj(s.targetObj);
        }
        function element_value_change(e) {
            //alert(e);
            var s = e.target;
            var o = s.parentNode.targetObj;
            var x;
            switch (s.valuetype)
            {
                case "string":
                    x = o[s.name];
                    break;
                case "json":
                    x = JSON.stringify(o[s.name]);
                    break;
                case "vertex":
                    x = o[s.name].id;
                    break;
            }
            x = prompt(s.name, x);
            switch (s.valuetype)
            {
                case "string":
                    o[s.name] = x;
                    break;
                case "json":
                    try
                    {
                        x = JSON.parse(x);
                        if (x)
                        {
                            o[s.name] = x;
                        }
                    }
                    catch (e)
                    {
                        Log.error(e);
                    }
                    break;
                case "vertex":
                    x = findVertexById(x);
                    if (x)
                    {
                        o[s.name].edges.remove(o);
                        o[s.name] = x;
                        x.edges.add(o);
                    }
                    break;
            }
            update(o);
        }
        function layer_click(e)
        {
            select(e.target.targetObj);
        }
        function layer_dblclick(e)
        {
            removeObj(e.target.targetObj);
        }

        function layer_vertex_dragstart()
        {
            //Log.debug("dragstart");
            mymap.dragging.disable();
            mymap.on(event_map_dragging_layer);
        }
        function layer_vertex_dragend()
        {
            //Log.debug("dragend");
            mymap.off(event_map_dragging_layer);
            mymap.dragging.enable();
        }
        function layer_vertex_dragend_if_up(e)
        {
            Log.debug(e.originalEvent.button);
            //layer_vertex_dragend(e);
        }

        function map_drag(e)
        {
            setLocation(selected, e.latlng);
        }

        var event_vertex = { mousedown: layer_click, dblclick: layer_dblclick };
        var event_edge = { click: layer_click, dblclick: layer_dblclick };
        var event_draggable_vertex = { mousedown: layer_vertex_dragstart, mouseup: layer_vertex_dragend };
        var event_map_dragging_layer = { mousemove: map_drag, mouseup: layer_vertex_dragend /*, mouseover: layer_vertex_dragend_if_up*/ };

        function create_new_element(btn)
        {
            var e = btn.ownerDocument.createElement("div");
            e.classList.add("listelement");
            //e.innerHTML = "test";
            btn.parentNode.insertBefore(e, btn);
            return e;
        }
        var vertex_id_counter = 0;
        function create_new_vertex(btn, obj) {
            var e = create_new_element(btn);
            e.addEventListener("click", element_click);
            e.addEventListener("dblclick", element_dblclick);
            if (!obj)
                obj = { id: "v" + vertex_id_counter++, name: "New vertex", loc: getDefaultLocation() };
            obj.type = "vertex";
            obj.edges = new List();
            obj.targetElement = e;
            obj.layer = L.circleMarker(obj.loc, vertex_style_default)
                .on(event_vertex)
                .on(event_draggable_vertex)
                .addTo(mymap);
            obj.node = V.add(obj);
            obj.layer.targetObj = obj;
            e.targetObj = obj;
            //alert(obj.loc);
            var doc = btn.ownerDocument;
            var s;

            s = doc.createElement("span");
            s.classList.add("label");
            s.innerHTML = "id: ";
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("input");
            s.name = "id";
            s.valuetype = "string";
            s.addEventListener("click", element_value_change);
            e.input_id = s;
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("label");
            s.innerHTML = ", name: ";
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("input");
            s.name = "name";
            s.valuetype = "string";
            s.addEventListener("click", element_value_change);
            e.input_name = s;
            e.appendChild(s);

            updateVertex(obj);

            select(obj);
        }

        function create_new_edge(btn, obj) {
            var e = create_new_element(btn);
            e.addEventListener("click", element_click);
            e.addEventListener("dblclick", element_dblclick);
            if (!obj)
                obj = { name: "New Edge", vs: two_vertices[1], ve: two_vertices[0], w: null, f: {} };
            obj.type = "edge";
            if (obj.vs)
                obj.vs.edges.add(obj);
            if (obj.ve)
                obj.ve.edges.add(obj);
            obj.targetElement = e;
            obj.layer = L.polyline([obj.vs ? obj.vs.loc : getDefaultLocation(), obj.ve ? obj.ve.loc : getDefaultLocation()], edge_style_default)
                .on(event_edge)
                .addTo(mymap);
            obj.node = E.add(obj);
            obj.layer.targetObj = obj;
            e.targetObj = obj;
            //alert(obj.loc);
            var doc = btn.ownerDocument;
            var s;

            s = doc.createElement("span");
            s.classList.add("label");
            s.innerHTML = "name: ";
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("input");
            s.name = "name";
            s.valuetype = "string";
            s.addEventListener("click", element_value_change);
            s.innerHTML = obj.name;
            e.input_name = s;
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("label");
            s.innerHTML = ", vs: ";
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("input");
            s.name = "vs";
            s.valuetype = "vertex";
            s.addEventListener("click", element_value_change);
            s.innerHTML = obj.vs ? obj.vs.id : "(null)";
            e.input_vs = s;
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("label");
            s.innerHTML = ", ve: ";
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("input");
            s.name = "ve";
            s.valuetype = "vertex";
            s.addEventListener("click", element_value_change);
            s.innerHTML = obj.ve ? obj.ve.id : "(null)";
            e.input_ve = s;
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("label");
            s.innerHTML = ", w: ";
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("input");
            s.name = "w";
            s.valuetype = "json";
            s.addEventListener("click", element_value_change);
            s.innerHTML = JSON.stringify(obj.w);
            //Log.debug(JSON.stringify(obj.w));
            e.input_w = s;
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("label");
            s.innerHTML = ", f: ";
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("input");
            s.name = "f";
            s.valuetype = "json";
            s.addEventListener("click", element_value_change);
            s.innerHTML = JSON.stringify(obj.f);
            //Log.debug(JSON.stringify(obj.f));
            e.input_f = s;
            e.appendChild(s);

            updateEdge(obj);

            select(obj);
        }

    </script>

    <div id="uipanel">
        <div class="listcontainer">
            <div id="vlist" class="list">
                <div id="vbtn" class="newbutton" onclick="create_new_vertex(this)">Create Vertex</div>
            </div>
        </div><div class="listcontainer">
            <div id="elist" class="list">
                <div id="ebtn" class="newbutton" onclick="create_new_edge(this)">Create Edge</div>
            </div>
        </div>
    </div>

    <textarea id="json_string" readonly></textarea>

    <!-- 자바스크립트 -->
    <!-- 로그 시작 -->
    <script src="logging.js"></script>
    <script> Log.init(document.getElementById("debugMsgBox"));</script>
    <script src="coordinates.js"></script>
    <!--<script src="gps.js"></script>-->
    <script src="graphentities.js"></script>
    <script src="graphcalculations.js"></script>
    <script src="path.js"></script>
    <script src="geodata.js"></script>
    <script src="timetable.js"></script>
    <script src="userdata.js"></script>
    <script src="weather.js"></script>
    <script>
        Log.info("Log framework started");

        // Leaflet.js 설정
        var mymap = L.map('mapid').setView([37.565149, 126.938016], 16);
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 20,
        id: 'mapbox.streets',
        accessToken: 'pk.eyJ1IjoiY2hhbnNvbDk4IiwiYSI6ImNqZ25henV1dTJibjgycXBxeGczaWk2enMifQ.w474LPaUpTnZiQnw5E3Ujg'
        }).addTo(mymap);

        var pane_vertices = mymap.createPane("vertices", mymap.getPane("overlayPane"));
        var pane_edges = mymap.createPane("edges", mymap.getPane("overlayPane"));
        var pane_selected = mymap.createPane("selected", mymap.getPane("overlayPane"));
        pane_vertices.style.zIndex = 1002;
        pane_edges.style.zIndex = 1001;
        pane_selected.style.zIndex = 1003;

        // 지도에 마커 생성.
        // 초기 위치는 연세대 정문.
        var currentLocationMarker=L.marker(L.latLng(CoordinateConversions.centerCoords.lat,
                                                    CoordinateConversions.centerCoords.long),
                                            {"title":"Your location","autoPan":true});
        //currentLocationMarker.addTo(mymap);

        mymap.on("click", function (e) {
            //if (e.sourceTarget == mymap && selected && selected.type == "vertex")
                //setLocation(selected, e.latlng);
        });

        function getDefaultLocation() {
            return mymap.getCenter();
        }

        jsonout = document.getElementById("json_string");
        jsonout.addEventListener("click", function () {
            var data = escape(getCurrentJSON());
            jsonout.innerHTML = data;
            storeData(data);
        });

        //document.body.addEventListener("load", function () {
        (function() {
            var data = loadData();
            if (data)
            {
                applyData(data);
            }
        })();

    </script>
</body>


</html>
