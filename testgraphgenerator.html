
<!DOCTYPE html>
<html>
<head>

    <meta charset="utf-8">

    <style>
        #mapid {
            height: 480px;
        }
    </style>

    <!-- leaflet.js 불러오기 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin=""></script>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }

        #mapid {
            height: 50%;
        }

        #uipanel {
            display: flex;
            flex-flow: row;
            height: 30%;
        }

        .listcontainer
        {
            border: 1px solid black;
            display: inline-block;
            width: 50%;
            height: 100%;
        }
        .list
        {
            display: flex;
            flex-flow: column;
            height: 100%;
            overflow-y: scroll;
        }
        .listelement
        {
            display: block;
            border: 2px solid transparent;
        }
        .listelement.selected
        {
            border-color: red;
            background-color: yellow;
        }
        .newbutton
        {
            display: block;
            text-align: center;
            background-color: lightgrey;
            padding: 7px;
            margin: 4px;
        }
        .input
        {
            color: blue;
        }

        #debugMsgBox {
            height: 20%;
        }
    </style>

    <script>
        function List() {
            this.h = {};
            this.h.next = this.h;
            this.h.prev = this.h;
            this.h.isHeader = true;

            this.add = function (e) {
                var ret = { v: e, next: this.h, prev: this.h.prev };
                this.h.prev.next = ret;
                this.h.prev = ret;
                return ret;
            }

            this.remove = function (n)//static
            {
                n.prev.next = n.next;
                n.next.prev = n.prev;
            }

            function Iterator(l) {
                this.p = l.h.next;

                this.end = function () {
                    return this.p.isHeader;
                }

                this.next = function () {
                    this.p = this.p.next;
                }

                this.get = function () {
                    return this.p.v;
                }

                this.remove = function () {
                    this.p.prev.next = this.p.next;
                    this.p.next.prev = this.p.prev;
                }
            }

            this.iterator = function () {
                return new Iterator(this);
            }
        }

        var V = new List(), E = new List();

        function updateVertex(v)
        {
            v.layer.setLatLng(v.loc);
            v.layer.setTooltipContent("[" + v.id + "]: " + v.name);
            v.targetElement.input_id.innerHTML = v.id;
            v.targetElement.input_name.innerHTML = v.name;
        }

        function setLocation(e, loc)
        {
            e.loc = loc;
            updateVertex(e);
        }

        var vertex_style_default =  { bubblingMouseEvents: false, radius: 12, stroke: false, fill: true, fillOpacity: 1, fillColor: "blue" };
        var vertex_style_selected = { bubblingMouseEvents: false, radius: 12, stroke: true, weight: 4, color: "lime", fill: true, fillOpacity: 1, fillColor: "blue" };
        var edge_style_default =    { bubblingMouseEvents: false, weight: 4, color: "red" };
        var edge_style_selected =   { bubblingMouseEvents: false, weight: 4, color: "lime" };

    </script>

</head>

<body>
    <!-- 지도 div -->
    <div id="mapid"></div>

    <script>
        var selected;

        function select(e)
        {
            if (e != selected)
            {
                if (selected)
                {
                    unselect[selected.type](selected);
                }
                select[e.type](e);
                selected = e;
            }
        }
        var unselect = {};

        select["vertex"] = function (e) {
            e.targetElement.classList.add("selected");
            e.layer.setStyle(vertex_style_selected);
        }
        select["edge"] = function (e) {
            e.targetElement.classList.add("selected");
            e.layer.setStyle(edge_style_selected);
        }
        unselect["vertex"] = function (e) {
            selected.targetElement.classList.remove("selected");
            selected.layer.setStyle(vertex_style_default);
        }
        unselect["edge"] = function (e) {
            selected.targetElement.classList.remove("selected");
            selected.layer.setStyle(edge_style_default);
        }

        
        function element_click(e)
        {
            var s = e.target;
            while (!s.targetObj)
                s = s.parentNode;
            select(s.targetObj);
        }
        function element_value_change(e)
        {
            //alert(e);
            var s = e.target;
            var o = s.parentNode.targetObj;
            o[s.name] = prompt(s.name, o[s.name]);
            updateVertex(o);
        }
        function layer_click(e)
        {
            select(e.target.targetObj);
        }

        function create_new_element(btn)
        {
            var e = btn.ownerDocument.createElement("div");
            e.classList.add("listelement");
            //e.innerHTML = "test";
            btn.parentNode.insertBefore(e, btn);
            return e;
        }
        function create_new_vertex(btn) {
            if (!this.c)
                this.c = 0;
            var e = create_new_element(btn);
            e.addEventListener("click", element_click);
            var obj = { type: "vertex", id: "v" + this.c++, name: "New vertex", loc: getDefaultLocation() };
            obj.targetElement = e;
            obj.layer = L.circleMarker(obj.loc, vertex_style_default)
                .on("click", layer_click)
                .addTo(mymap);
            obj.node = V.add(obj);
            obj.layer.targetObj = obj;
            e.targetObj = obj;
            //alert(obj.loc);
            var doc = btn.ownerDocument;
            var s;

            s = doc.createElement("span");
            s.innerHTML = "id: ";
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("input");
            s.name = "id";
            s.addEventListener("click", element_value_change);
            s.innerHTML = obj.id;
            e.input_id = s;
            e.appendChild(s);

            s = doc.createElement("span");
            s.innerHTML = ", name: ";
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("input");
            s.name = "name";
            s.addEventListener("click", element_value_change);
            s.innerHTML = obj.name;
            e.input_name = s;
            e.appendChild(s);

            updateVertex(obj);
        }

        function create_new_edge(btn) {
            var e = create_new_element(btn);
            e.addEventListener("click", element_click);
            var obj = { type: "edge", name: "New Edge", vs: undefined, ve: undefined, w: null, f: {} };
            obj.targetElement = e;
            obj.layer = L.polyline([getDefaultLocation()], edge_style_default)
                .on("click", layer_click)
                .addTo(mymap);
            obj.node = E.add(obj);
            obj.layer.targetObj = obj;
            e.targetObj = obj;
            //alert(obj.loc);
            var doc = btn.ownerDocument;
            var s;

            s = doc.createElement("span");
            s.innerHTML = "name: ";
            e.appendChild(s);

            s = doc.createElement("span");
            s.classList.add("input");
            s.name = "name";
            s.addEventListener("click", element_value_change);
            s.innerHTML = obj.name;
            e.input_name = s;
            e.appendChild(s);

            updateVertex(obj);
        }

    </script>

    <div id="uipanel">
        <div class="listcontainer">
            <div id="vlist" class="list">
                <div class="newbutton" onclick="create_new_vertex(this)">Create Vertex</div>
            </div>
        </div><div class="listcontainer">
            <div id="vlist" class="list">
                <div class="newbutton" onclick="create_new_edge(this)">Create Edge</div>
            </div>
        </div>
    </div>

    <!-- Log div -->
    <div id="debugMsgBox"></div>

    <!-- 자바스크립트 -->
    <!-- 로그 시작 -->
    <script src="logging.js"></script>
    <script> Log.init(document.getElementById("debugMsgBox"));</script>
    <script src="coordinates.js"></script>
    <!--<script src="gps.js"></script>-->
    <script src="graphentities.js"></script>
    <script src="graphcalculations.js"></script>
    <script src="path.js"></script>
    <script src="geodata.js"></script>
    <script src="timetable.js"></script>
    <script src="userdata.js"></script>
    <script src="weather.js"></script>
    <script>
        Log.info("Log framework started");

        // Leaflet.js 설정
        var mymap = L.map('mapid').setView([37.565149, 126.938016], 16);
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 20,
        id: 'mapbox.streets',
        accessToken: 'pk.eyJ1IjoiY2hhbnNvbDk4IiwiYSI6ImNqZ25henV1dTJibjgycXBxeGczaWk2enMifQ.w474LPaUpTnZiQnw5E3Ujg'
        }).addTo(mymap);

        // 지도에 마커 생성.
        // 초기 위치는 연세대 정문.
        var currentLocationMarker=L.marker(L.latLng(CoordinateConversions.centerCoords.lat,
                                                    CoordinateConversions.centerCoords.long),
                                            {"title":"Your location","autoPan":true});
        currentLocationMarker.addTo(mymap);

        mymap.on("click", function (e) {
            if (e.sourceTarget == mymap)
                setLocation(selected, e.latlng);
        });

        function getDefaultLocation()
        {
            return mymap.getCenter();
        }

    </script>
</body>


</html>
