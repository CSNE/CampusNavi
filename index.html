
<!DOCTYPE html>
<html>
  <head>

    <meta charset="utf-8">
    
    <!-- Disable Zoom -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    

    <!-- leaflet.js 불러오기 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin=""></script>
    <script src="jquery-3.3.1.min.js"></script>
    <script src="jquery.xdomainajax.js"></script>


    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style>
      html,body{
        height:100%;
        overflow:hidden;
      }



      #maincontent {
        display: flex;
        width:100%;
        height:100%;
      }
      #mapid{
        flex-grow:1;
      }

      /* PC */
      @media screen and (min-aspect-ratio: 4/3){
        #maincontent {
          flex-direction: row;
        }
        .uipanel{
          border-left:solid 1px gray;
        }

      }
      
      /* Mobile */
      @media screen and (max-aspect-ratio: 4/3){
        #maincontent {
          flex-direction: column;
        }
        
        .uipanel{
          border-top:solid 1px gray;
        }
      }


      .uipanel *{
        margin:4px;

        font-family: sans-serif;
      }


      #uipanel_search_grid{
        display: grid;
        grid-template-rows: auto auto auto;
        grid-template-columns: 1fr auto auto;
        grid-template-areas: "frominput fromlabel importttbtn" 
                             "toinput   tolabel   changebtn" 
                             "timeinput timelabel findbtn" ;
        grid-column-gap: 4px;
      }
      #uipanel_search_grid *{
        place-self: center;
        
        width:100%;
      }
      
      #uipanel_near_grid{
        display: grid;
        grid-template-rows: auto auto auto;
        grid-template-columns: auto 1fr auto auto;
        grid-template-areas: "frominput frominput fromlabel locsetbtn" 
                             "tolabel2  toinput   tolabel   changebtn" 
                             "timeinput timeinput timelabel findbtn" ;
        grid-column-gap: 4px;
      }
      #uipanel_near_grid *{
        place-self: center;
        
        width:100%;
      }
 

      .route_element{
        display: grid;

        grid-template-rows: auto auto auto;
        grid-template-columns: auto 1fr auto;
        grid-template-areas: "icon name        gobtn" 
                             "icon time        gobtn" 
                             "icon arrivaltime gobtn" ;
        border:1px solid black;
      }
      .route_element *{
        place-self: center;
      }
      .route_name{grid-area:name;}
      .route_icon{
        grid-area:icon;
        width:24px;
        height:24px;
      }
      .route_time{grid-area:time;}
      .route_arrivaltime{grid-area:arrivaltime;}
      
      .arrival_ontime{
        color:green;
      }
      .arrival_late{
        color:red;
      }
      .route_begin{grid-area:gobtn}

      #debugpanel{
        height:100%;
        width:100%;
        position:fixed;
        z-index:5000;
        left:0;
        top:0;
        background-color: white;
        opacity:0.8;
        display:flex;
        flex-direction: column;
      }
      #logcontainer{
        flex-grow:1;
      }
      #debug_panel_toggle{
        z-index:10000;
        position:fixed;
        left:0;
        bottom:0;
        opacity:0.7;
        font-size:16px;
      }
      
      #uipanel_fromto_grid{
        display: grid;
        grid-template-rows: auto auto auto;
        grid-template-columns: 1fr auto auto;
        grid-template-areas: "frominput fromlabel autobtn" 
                             "toinput   tolabel   changebtn" 
                             "timeinput timelabel findbtn" ;
        grid-column-gap: 4px;
      }
      #uipanel_fromto_grid *{
        place-self: center;
        display:flex;
        flex-direction:row;
        
        width:100%;
      }

      #uipanel_navigation_container{
        display: grid;

        grid-template-rows: auto auto auto;
        grid-template-columns: auto 1fr auto;
        grid-template-areas: "routename      .        targettime" 
                             "canvas         canvas   canvas" 
                             "timeremaining  .        eta" ;
        border:1px solid black;
      }
      #uipanel_navigation_grid *{
        place-self: center;
      }
      #navigation_routename{grid-area:routename;}
      #navigation_targettime{grid-area:targettime;}
      #navigation_canvas{
        grid-area:canvas;
        height:100px;
      }
      #navigation_timeremaining{grid-area:timeremaining;}
      #navigation_eta{grid-area:eta;}

      
      #uipanel_near{
        display:flex;
        flex-direction: column;
      }
      
      #uipanel_tabs{
        display:flex;
        flex-direction: row;
        overflow-x:auto;
        
        margin-left:0;
        padding-left:4px;
        margin-right:0;
        padding-right:4px;
        border-bottom: solid 1px black;
      }
      #uipanel_tabs *{
        flex-grow: 1;
        margin:4px;
        margin-bottom: 0;
        padding:4px;
        border: 1px solid black;
        border-bottom:none;
        background-color: white;
      }
      
      #uipanel_tabs .selected_tab{
        background-color: orange !important;
      }
      
      #uipanel_tabs .unclickable_tab{
        background-color: lightgray;
      }
      
      .clickable{
        cursor: pointer;
      }
      
      #uipanel_persistant{
        display:flex;
        flex-direction: row;
        
        padding-top:4px;
        padding-bottom: 4px;
        margin-left:0;
        padding-left:8px;
        margin-right:0;
        padding-right:8px;
        
        border-bottom: solid 1px black;
      }
      
      #uipanel_persistant *{
        margin:0;
      }
      
      #uipanel_persistant_right{
        display:flex;
        
      }
      #uipanel_persistant_right_texts{
        align-self: flex-end;
      }

      #uipanel_persistant_spacer{
        flex-grow: 1;
      }
      
      .uitext_good{
        color:green;
      }
      .uitext_okay{
        color:orange;
      }
      .uitext_bad{
        color:red;
      }
      .uitext_unknown{
        color:gray;
      }
      
      .buttonanchor{
        appearance: button;
      }
      .centerer{
        display: flex;
        justify-content: center;
      }

    </style>

  </head>

  <body>
    <button id="debug_panel_toggle">
      Debug Panel
    </button>
    <div id="debugpanel" style="display:none;">
      <div id="debug_buttons_container">
        <button onclick="debug_button_1_onclick()">Fake Location Mode</button>
        <button onclick="debug_button_2_onclick()">Weather: Good</button>
        <button onclick="debug_button_3_onclick()">Weather: Okay</button>
        <button onclick="debug_button_4_onclick()">Weather: Bad</button>
        <button onclick="debug_button_5_onclick()">Log.error()</button>        
        <button onclick="debug_button_6_onclick()">Override timetable time</button>        
        <button onclick="debug_button_7_onclick()">Hide debug menus</button>
      </div>
      <div id="logcontainer"></div>
    </div>
    <div id="maincontent">
      <!-- 지도 div -->
      <div id="mapid"></div>

      <div class="uipanel" >
        
        <div id="uipanel_persistant">
          <div id="uipanel_persistant_left">
            <strong style="font-size:1.3em;">CampusNavi</strong>
          </div>
          <div id="uipanel_persistant_spacer">&nbsp;&nbsp;</div>
          <div id="uipanel_persistant_right">
            <span id="uipanel_persistant_right_texts">
              <sub>날씨 </sub><span id="uipanel_weather_weather_display" class="uitext_unknown">???</span>
              <sub>&nbsp;&nbsp;온도 </sub><span id="uipanel_weather_temps_display" class="uitext_unknown">???</span>
              <sub>&nbsp;&nbsp;미세먼지 </sub><span id="uipanel_weather_air_display" class="uitext_unknown">???</span>
            </span>
          </div>
          
        </div>
        <div id="uipanel_tabs">
          <!--<div id="uipanel_tabs_search" class="clickable selected_tab">Search</div>-->
          <!--<div id="uipanel_tabs_nearby" class="clickable">Nearby</div>-->
          <div id="uipanel_tabs_fromto" class="clickable selected_tab">From to</div>
          <div id="uipanel_tabs_settings" class="clickable">Settings</div>
          <div id="uipanel_tabs_routelist" class="unclickable_tab">Route</div>
          <div id="uipanel_tabs_navigation" class="unclickable_tab">Navigation</div>
        </div>
        <!-- form 처럼 작동하도록 함 (return 입력시 전송), div와 같은 레이아웃 -->
        <!--
        <form id="uipanel_search" action="javascript:">
          <div id="uipanel_search_grid">
            <input type="text" list="destinationsData" id="uipanel_search_input_from" tabindex="1" style="grid-area: frominput;width:100%;">

            <div style="grid-area: fromlabel;">부터</div>
            
            <input type="button" value="자동 설정" id="uipanel_search_button_importtt" style="grid-area: importttbtn;" />
            
            <input type="button" value="바꾸기" id="uipanel_search_swap_src_dst" tabindex="4" style="grid-area: changebtn;" />

            <input type="submit" value="탐색" id="uipanel_search_button_find" tabindex="5" style="grid-area: findbtn;" />

            <input type="text" list="destinationsData" id="uipanel_search_input_to" tabindex="2" style="grid-area: toinput;width:100%;">

            <div style="grid-area: tolabel;">까지</div>

            
            <input type="time" id="uipanel_search_input_time" tabindex="3" style="grid-area: timeinput;width:100%;">

            <div style="grid-area: timelabel;">까지</div>

          </div>
        </form>
        
        <form id="uipanel_near" action="javascript:" style="display: none;">
          <div id="uipanel_near_grid">
            <input type="text" list="destinationsData" id="uipanel_near_input_from" tabindex="1" style="grid-area: frominput;width:100%;">
            <div style="grid-area: fromlabel;">부터</div>
            
            <input type="button" value="현재 위치" id="uipanel_near_location_set" style="grid-area: locsetbtn;" />
            <input type="submit" value="탐색" id="uipanel_near_button_find" tabindex="5" style="grid-area: findbtn;" />
            <select id="uipanel_near_input_to" tabindex="2" style="grid-area: toinput;width:100%;">
            </select>
            <div style="grid-area: tolabel;">까지</div>
            <div style="grid-area: tolabel2;">가장 가까운</div>

            <input type="time" id="uipanel_near_input_time" tabindex="3" style="grid-area: timeinput;width:100%;">
            <div style="grid-area: timelabel;">까지</div>
          </div>
        </form>
        -->
        <datalist id="destinationsData"></datalist>

        <div id="uipanel_fromto" style="">
          <div id="uipanel_fromto_grid">
            <form id="uipanel_fromto_from" action="javascript:" style="grid-area: frominput;">
              <select id="uipanel_fromto_from_method" style="grid-area: frominput;">
                <option value="0">위치 설정</option>
                <option value="1">검색</option>
                <option value="2">지도</option>
                <option value="3">편의시설</option>
                <option value="4">현재 위치</option>
                <option value="5">건물</option>
              </select>
              <div style="display: inline-block;" id="uipanel_fromto_from_display" ></div>
              <input id="uipanel_fromto_from_input1" style="display: none;"/>
              <select id="uipanel_fromto_from_near" style="display: none;"></select>
              <input type="submit" value="선택" id="uipanel_fromto_from_submit" style="display: none;"/>
            </form>
            <div style="grid-area: fromlabel;">부터</div>
            <form id="uipanel_fromto_to" action="javascript:"  style="grid-area: toinput;">
              <select id="uipanel_fromto_to_method">
                <option value="0">위치 설정</option>
                <option value="1">검색</option>
                <option value="2">지도</option>
                <option value="3">편의시설</option>
                <option value="4">현재 위치</option>
                <option value="5">건물</option>
              </select>
              <div style="display: inline-block;" id="uipanel_fromto_to_display" ></div>
              <input id="uipanel_fromto_to_input1" style="display: none;"/>
              <select id="uipanel_fromto_to_near" style="display: none;"></select>
              <input type="submit" value="선택" id="uipanel_fromto_to_submit" style="display: none;" />
            </form>
            <div style="grid-area: tolabel;">까지</div>

            <input type="button" value="탐색" id="uipanel_fromto_button_find" tabindex="5" style="grid-area: findbtn;" />
            <input type="time" id="uipanel_fromto_input_time" tabindex="3" style="grid-area: timeinput;width:100%;">
            <div style="grid-area: timelabel;">까지</div>

            <input type="button" value="자동 설정" id="uipanel_fromto_button_importtt" style="grid-area: autobtn;" />

            <input type="button" value="바꾸기" id="uipanel_fromto_swap_src_dst" tabindex="4" style="grid-area: changebtn;" />
          </div>
          <script>
            var vin_from, vin_to;
            (function () {
              function VertexInput(id, e) {
                this.id = id;
                this.e = e;
                //alert(e);
                this.value = null;
                this.name = "";
                this.method = 0;
                function method_change() {
                  var m = this.e.method.value;
                  //alert(m);
                  switch (m) {
                    case "0":
                      this.e.inputs[0].style.display = "none";
                      this.e.near.style.display = "none";
                      this.e.submit.style.display = "none";
                      this.e.display.style.display = "none";
                      this.value = null;
                      this.name = "";
                      this.method = 0;
                      break;
                    case "1":
                      this.e.inputs[0].style.display = "initial";
                      this.e.inputs[0].setAttribute("list","destinationsData");
                      this.e.near.style.display = "none";
                      this.e.submit.style.display = "initial";
                      this.e.display.style.display = "none";
                      this.method = 1;
                      break;
                    case "2":
                      this.e.inputs[0].style.display = "none";
                      this.e.near.style.display = "none";
                      this.e.submit.style.display = "none";
                      this.e.display.style.display = "none";
                      this.method = 2;
                      break;
                    case "3":
                      this.e.inputs[0].style.display = "none";
                      this.e.near.style.display = "initial";
                      this.e.submit.style.display = "initial";
                      this.e.display.style.display = "none";
                      this.method = 3;
                      break;
                    case "4":
                      this.e.inputs[0].style.display = "none";
                      this.e.near.style.display = "none";
                      this.e.submit.style.display = "none";
                      this.e.display.style.display = "initial";
                      this.method = 0;
                      this.setValue(GraphCalculations.nearestVertexToPoint(Geodata.graph, GPS.getCurrentLocation(), false), "현재 위치");
                      break;
                    case "5":
                      this.e.inputs[0].style.display = "initial";
                      this.e.inputs[0].removeAttribute("list");
                      this.e.near.style.display = "none";
                      this.e.submit.style.display = "initial";
                      this.e.display.style.display = "none";
                      this.method = 5;
                      break;
                    default:
                      Log.error("unknown method: " + m);
                      return;
                  }
                }
                function submit()
                {
                  var v, name;
                  switch (this.method)
                  {
                    case 1:
                      name = this.e.inputs[0].value;
                      v = Geodata.graph.findVertexWithName(name);
                      break;
                    case 3:
                      name = this.e.near.value;
                      v = places[name];
                      name = "가장 가까운 " + name;
                      //TODO: name("convenient") -> "편의점"
                      break;
                    case 5:
                      name = this.e.inputs[0].value;
                      v = places[name];
                      break;
                  }
                  this.setValue(v, name);
                  this.e.method.value=0;
                }
                function setValue(v, name)
                {
                  if (v) {
                    this.value = v;
                    this.name = name;
                    this.e.inputs[0].style.display = "none";
                    this.e.near.style.display = "none";
                    this.e.submit.style.display = "none";
                    this.e.display.style.display = "initial";
                    this.method = 0;
                    this.e.display.innerHTML = name;
                  }
                }
                this.method_change = method_change;
                this.submit = submit;
                this.setValue = setValue;
                var thiss = this;
                e.method.addEventListener("change", function () {
                  thiss.method_change();
                  
                });
                e.root.addEventListener("submit", function () {
                  thiss.submit();
                });
              }
              var from_elements = {
                "root": document.getElementById("uipanel_fromto_from"),
                "method": document.getElementById("uipanel_fromto_from_method"),
                "inputs": [document.getElementById("uipanel_fromto_from_input1")],
                "near": document.getElementById("uipanel_fromto_from_near"),
                "submit": document.getElementById("uipanel_fromto_from_submit"),
                "display": document.getElementById("uipanel_fromto_from_display")
              };

              var to_elements = {
                "root": document.getElementById("uipanel_fromto_to"),
                "method": document.getElementById("uipanel_fromto_to_method"),
                "inputs": [document.getElementById("uipanel_fromto_to_input1")],
                "near": document.getElementById("uipanel_fromto_to_near"),
                "submit": document.getElementById("uipanel_fromto_to_submit"),
                "display": document.getElementById("uipanel_fromto_to_display")
              };
              vin_from = new VertexInput("from", from_elements);
              vin_to = new VertexInput("from", to_elements);
            })();
          </script>
        </div>


        <div id="uipanel_routes" style="display:none">
            <div id="uipanel_route_message" style="text-align: center;"></div>
          <template id="route_template">
            <div class="route_element">
              <img class="route_icon">
              <div class="route_name"></div>
              <div class="route_time"></div>
              <div class="route_arrivaltime"></div>
              <button class="route_begin">Go!</button>
            </div>
          </template>
          <div id=uipanel_route_list>

          </div>


        </div>

        <div id="uipanel_navigation" style="display:none">
          <div id="uipanel_navigation_container">

            <div id="navigation_routename"></div>
            <div id="navigation_targettime"></div>
            <div id="navigation_canvas" style="position:relative;padding:0;margin:0;">
              <canvas id="navigation_canvas_element" style="padding:0;margin:0;position:absolute;top:0;bottom:0;left:0;right:0;">
                Canvas not supported! Update your browser before you turn into a fossil.
              </canvas>
            </div>
            <div id="navigation_timeremaining"></div>
            <div id="navigation_eta"></div>
          </div>
        </div>
        <div id="uipanel_settings" style="display:none">
          <div class="centerer">
            <button onclick="location.href='timetableeditor.html'" style="margin:0 auto;width:100%;height:50px;font-size:1.5em;">
              Timetable Editor
            </button>
          </div>
        </div>
      </div>


    </div>

    <!-- 자바스크립트 -->
    <!-- 로그 시작 -->
    <script src="logging.js"></script>
    <script> Log.init(document.getElementById("logcontainer"));Log.info("Log framework started");</script>
    <script src="vector.js"></script>
    <script src="matrices.js"></script>
    <script src="coordinates.js"></script>
    <script src="gps.js"></script>
    <script src="graphentities.js"></script>
    <script src="graphcalculations.js"></script>
    <script src="path.js"></script>
      <script src="testgeodata.js"></script>
    <script src="geodata.js"></script>
    <script src="navigationcontext.js"></script>
    <script src="timetable.js"></script>
    <script src="userdata.js"></script>
    <script src="weather.js"></script>
    <script src="util.js"></script>
    <script>
      Log.info("All JS loaded.");

      Log.debug("Screen size "+window.innerWidth+"x"+window.innerHeight);

      // Leaflet.js 설정
      var mymap = L.map('mapid').setView([37.565149, 126.938016], 16);
      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}@2x.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 20,
        id: 'mapbox.streets',
        accessToken: 'pk.eyJ1IjoiY2hhbnNvbDk4IiwiYSI6ImNqZ25henV1dTJibjgycXBxeGczaWk2enMifQ.w474LPaUpTnZiQnw5E3Ujg',
        tileSize:256
      }).addTo(mymap);


        // Pane 생성
      (function () {
          function ovp(name, z) {
              var p = mymap.createPane(name, mymap.getPane("overlayPane"));
              p.style.zIndex = z;
          }
          ovp("vertices", 1003);
          ovp("edges", 1002);
          ovp("underground", 1001);
          ovp("markers", 1010);
          ovp("debug", 2000);
      })();

      // 지도에 마커 생성.
      // 초기 위치는 연세대 정문.
      var currentLocationMarker=L.circleMarker(L.latLng(CoordinateConversions.centerCoords.lat,
                                                        CoordinateConversions.centerCoords.lng),
                                               {
        "pane": "markers",
        "title": "Your location", "autoPan": true,
        "radius": 6,
        "weight": 1,
        "color": "#0B4AB5",
        //"stroke": false,
        "fill": true,
        "fillOpacity": 1,
        "fillColor": "#689DF6"
      });
      currentLocationMarker.addTo(mymap);

      var debugMarker=L.circleMarker(L.latLng(CoordinateConversions.centerCoords.lat,
                                                        CoordinateConversions.centerCoords.lng),
                                               {
        "pane": "debug",
        "title": "Your location", "autoPan": true,
        "radius": 6,
        "weight": 1,
        "color": "#FF0000",
        //"stroke": false,
        "fill": true,
        "fillOpacity": 1,
        "fillColor": "#FF8080"
      });
      debugMarker.addTo(mymap);
      
      
      

      GPS.startTracking();
      GPS.addLocationListener(function(coords){
        var latlng=coords.toLatLng();
        currentLocationMarker.setLatLng(latlng);
        if (!this.not_first) {
          mymap.setView(latlng);
          this.not_first = true;
        }
      });

	  
	    
      var timeTableData=new TimeTable();
      //timeTableData.loadTimeTable();
	  

      var places = {};
      Geodata.addUpdateListener(function () {
        //Datalist에 꼭짓점 이름들을 넣음.
        //place정보를 저장함
        var destinationsDataList = document.getElementById("destinationsData");
        while (destinationsDataList.hasChildNodes())
          destinationsDataList.removeChild(destinationsDataList.lastChild);
        for (var i = 0; i < Geodata.graph.vertices.length; i++) {
          var v = Geodata.graph.vertices[i];
          if (v.shown) {
            var opt = document.createElement("option");
            opt.setAttribute("value", v.name);
            destinationsDataList.appendChild(opt);

            if (v.place) {
              for (var j = 0; j < v.place.length; j++) {
                var p = v.place[j];
                if (!places[p])
                  places[p] = [];
                places[p].push(v);
              }
			  /*if(timeTableData.locationCheck(v.id)==0) { //
				if(!places[v.id]) places[v.id] = []; //
				places[v.id].push(v); //
			  }*/
            }
          }
        }
        Log.debug(JSON.stringify(Geodata.obj.places) || "");
        for (var j in {"uipanel_fromto_from_near": 0, "uipanel_fromto_to_near": 0}) {
          var s = document.getElementById(j);
          while (s.hasChildNodes())
            s.removeChild(s.lastChild);
          for (var i in Geodata.obj.places) {
            var p = Geodata.obj.places[i];
            if (!places[i])
              places[i] = [];
            if (p.searched) {
              var opt = document.createElement("option");
              opt.setAttribute("value", i);
              opt.innerHTML = p.name;
              s.appendChild(opt);
            }
          }
        }
      });

      Geodata.load("mapdata.json");
        
            
      //Icons
      var route_icon_path = {
        walk: "icons/baseline-directions_walk-24px.png",
        run: "icons/baseline-directions_run-24px.png",
        fly: "icons/baseline-directions_run-24px.png"
      };
      var route_icon_HTMLImageElement={
        walk: new Image(),
        run: new Image(),
        fly: new Image()
      }
      route_icon_HTMLImageElement.walk.src=route_icon_path.walk;
      route_icon_HTMLImageElement.run.src=route_icon_path.run;
      route_icon_HTMLImageElement.fly.src=route_icon_path.fly;

      //HTML DOM 변수들.
      //var uipanel_search=document.getElementById("uipanel_search");
      //var uipanel_near=document.getElementById("uipanel_near");
      var uipanel_fromto = document.getElementById("uipanel_fromto");
      var uipanel_routes=document.getElementById("uipanel_routes");
      var uipanel_navigation=document.getElementById("uipanel_navigation");
      var uipanel_settings=document.getElementById("uipanel_settings");


      var uipanel_route_list=document.getElementById("uipanel_route_list");
      var uipanel_route_message=document.getElementById("uipanel_route_message");
      

      var fromto_input_time = document.getElementById("uipanel_fromto_input_time");
      var fromto_button_importTT = document.getElementById("uipanel_fromto_button_importtt");
      var fromto_button_swap = document.getElementById("uipanel_fromto_swap_src_dst");
      var fromto_button_find = document.getElementById("uipanel_fromto_button_find");

      var routeTemplate = document.getElementById("route_template");




      var navigation_routename=document.getElementById("navigation_routename");
      var navigation_targettime=document.getElementById("navigation_targettime");
      var navigation_canvas=document.getElementById("navigation_canvas");
      var navigation_timeremaining=document.getElementById("navigation_timeremaining");
      var navigation_eta=document.getElementById("navigation_eta");


      
      
      //var uipanel_tabs_search=document.getElementById("uipanel_tabs_search");
      //var uipanel_tabs_nearby=document.getElementById("uipanel_tabs_nearby");
      var uipanel_tabs_fromto = document.getElementById("uipanel_tabs_fromto");
      var uipanel_tabs_settings=document.getElementById("uipanel_tabs_settings");
      var uipanel_tabs_routelist=document.getElementById("uipanel_tabs_routelist");
      var uipanel_tabs_navigation=document.getElementById("uipanel_tabs_navigation");
      
      
      var uipanel_weather_weather_display=document.getElementById("uipanel_weather_weather_display");
      var uipanel_weather_air_display=document.getElementById("uipanel_weather_air_display");
      var uipanel_weather_temps_display=document.getElementById("uipanel_weather_temps_display");
        
        
      Weather.addCallback(function(){
        Log.debug("Displaying weather data.");
        uipanel_weather_weather_display.innerHTML=Weather.getCurrentWeatherNameKorean();
        uipanel_weather_weather_display.className='';
        uipanel_weather_weather_display.classList.add("uitext_"+Weather.getCurrentWeatherGrade());
        
        uipanel_weather_air_display.innerHTML=Weather.getCurrentDustLevelsInShinchon();
        uipanel_weather_air_display.className='';
        uipanel_weather_air_display.classList.add("uitext_"+Weather.getCurrentDustGrade());
        
        uipanel_weather_temps_display.innerHTML=Weather.getCurrentWeatherInShinchon().temperature;
        uipanel_weather_temps_display.className='';
        uipanel_weather_temps_display.classList.add("uitext_"+Weather.getCurrentTemperatureGrade());
      });
      
      //Try Weather.fetch() 5 times, 5 seconds apart.
      var weatherFetchTries=5;
      function tryFetchingUntilSucceeds(){
        weatherFetchTries--;
        if (weatherFetchTries<0){
          Log.error("Weather fetch failed after 5 tries!");
          return;
        }
        
        if (Weather.getCurrentWeatherInShinchon() !==null &&
            Weather.getCurrentDustLevelsInShinchon()!==null){
          //exit
          Log.debug("Exiting weather data fetching loop.");
          return;
        }
        Weather.fetch();
        setTimeout(tryFetchingUntilSucceeds,5000);
      }
      tryFetchingUntilSucceeds();
      
        
      
      
      //TODO fix dis
      //This code WILL BREAK if:
      //the program is run anytime between 23:27~23:59
      //set time
      var nearestNiceTime=new Date();
      var nearestNiceMinute=nearestNiceTime.getMinutes();
      var nearestNiceHour=nearestNiceTime.getHours();
      
      nearestNiceMinute=nearestNiceMinute+3; //add 3
      nearestNiceMinute=Math.ceil(nearestNiceMinute/30)*30 //go to upcoming 30-min time
      if (nearestNiceMinute>=60){
        nearestNiceMinute=nearestNiceMinute-60;
        nearestNiceHour++;
      }
      nearestNiceTime.setHours(nearestNiceHour);
      nearestNiceTime.setMinutes(nearestNiceMinute);
      nearestNiceTime.setSeconds(0);
      
      
      
      fromto_input_time.value = nearestNiceTime.toTimeString().split(" ")[0]
      
      //Canvas
      var canvasContainer=document.getElementById("navigation_canvas");
      var canvas=document.getElementById("navigation_canvas_element");
          
      var canvasContext=canvas.getContext("2d");
      
      
      function displayProgessOnCanvas(completionRatio,imageElementObject){
        
        //2x for HiDpi screens
        /*
        canvas.height=canvasContainer.offsetHeight*2;
        canvas.width=canvasContainer.offsetWidth*2;
        
        canvas.style.width=canvasContainer.offsetWidth;
        canvas.style.height=canvasContainer.offsetHeight;
        */
        var cW=canvasContainer.offsetWidth;
        var cH=canvasContainer.offsetHeight;
        var pixelMultiplier=2;//window.devicePixelRatio;
        canvas.width=cW*pixelMultiplier;
        canvas.height=cH*pixelMultiplier;        
        canvas.style.width=cW+"px";
        canvas.style.height=cH+"px";
        
        var currentCanvasW=canvas.width;
        var currentCanvasH=canvas.height;
        
        var rectMarginX=20*pixelMultiplier;
        var rectMarginY=20*pixelMultiplier;
        
        var rectHeight=10*pixelMultiplier;
        
        var rectWidth=currentCanvasW-rectMarginX*2;
        var rectCompletedWidth=Math.round(rectWidth*completionRatio);
        var rectUncompletedWidth=rectWidth-rectCompletedWidth;
        
        var rectCompletedStartX=rectMarginX;
        var rectCompletedStartY=currentCanvasH-rectMarginY-rectHeight;
        var rectUnCompletedStartX=rectMarginX+rectCompletedWidth;
        var rectUnCompletedStartY=rectCompletedStartY;
        
        
        canvasContext.clearRect(0,0,currentCanvasW,currentCanvasH);
        
        //Completed Part
        canvasContext.fillStyle="#000000";
        canvasContext.fillRect(rectCompletedStartX,
                               rectCompletedStartY,
                               rectCompletedWidth,
                               rectHeight);
        
        //Uncompleted Part
        canvasContext.fillStyle="#707070";
        canvasContext.fillRect(rectUnCompletedStartX,
                               rectUnCompletedStartY,
                               rectUncompletedWidth,
                               rectHeight);
        
        
        //Icon
        var imageSizeX=30*pixelMultiplier;
        var imageSizeY=30*pixelMultiplier;
        var imageMarginY=0*pixelMultiplier;
        
        var imageCenterX=rectUnCompletedStartX;
        var imageEndY=rectUnCompletedStartY-imageMarginY;
        
        var imageStartX=imageCenterX-imageSizeX/2;
        var imageStartY=imageEndY-imageSizeY;
        
        canvasContext.drawImage(imageElementObject,
                                imageStartX,
                                imageStartY,
                                imageSizeX,
                                imageSizeY);
        
        var imageEndX=imageStartX+imageSizeX;
        
        //Text
        var textMarginY=5*pixelMultiplier;
        var textY=imageEndY-textMarginY;
        
        canvasContext.fillStyle="#000000";
        canvasContext.font=(18*pixelMultiplier)+"px sans-serif";
        if (completionRatio<0.5){
          canvasContext.textAlign="left";
          canvasContext.fillText((completionRatio*100).toFixed(1)+"%",
                                 imageEndX,
                                 textY);
          
        }else{
          canvasContext.textAlign="right";
          canvasContext.fillText((completionRatio*100).toFixed(1)+"%",
                                 imageStartX,
                                 textY);
        }
        
      }
      


      //UI 이벤트 처리 함수들.
      
      //Called whenever a state change occurs.
      var uiStateChangeListener=[];
      
      function undisplayAll(){
        for(var i=0;i<uiStateChangeListener.length;i++) uiStateChangeListener[i]();
        //uipanel_search.style.display="none";
        uipanel_routes.style.display="none";
        //uipanel_near.style.display="none";
        uipanel_fromto.style.display = "none";
        uipanel_navigation.style.display="none";
        uipanel_settings.style.display="none";
        //uipanel_tabs_search.classList.remove("selected_tab");
        //uipanel_tabs_nearby.classList.remove("selected_tab");
        uipanel_tabs_fromto.classList.remove("selected_tab");
        uipanel_tabs_settings.classList.remove("selected_tab");
        uipanel_tabs_routelist.classList.remove("selected_tab");
        uipanel_tabs_navigation.classList.remove("selected_tab");
        cleanRouteList();
        mymap.invalidateSize();
      }
      /*
      function displaySearchPanel(){
        undisplayAll();
        uipanel_search.style.display="block";
        uipanel_tabs_search.classList.add("selected_tab");
      }function displayNearPanel(){
        undisplayAll();
        uipanel_near.style.display="flex";
        uipanel_tabs_nearby.classList.add("selected_tab");
      }
      //*/
      function displayFromToPanel() {
        undisplayAll();
        uipanel_fromto.style.display = "initial";
        uipanel_tabs_fromto.classList.add("selected_tab");
      }
      function displayRouteListingPanel(){
        undisplayAll();
        uipanel_routes.style.display="block";
        uipanel_tabs_routelist.classList.add("selected_tab");
      }function displayNavigationPanel(){
        undisplayAll();
        uipanel_navigation.style.display="block";
        uipanel_tabs_navigation.classList.add("selected_tab");
      }function displaySettingsPanel(){
        undisplayAll();
        uipanel_settings.style.display="block";
        uipanel_tabs_settings.classList.add("selected_tab");
      }

      function cleanRouteList(){
        //remove all route listings
        while (uipanel_route_list.firstChild) {
          uipanel_route_list.removeChild(uipanel_route_list.firstChild);
        }
      }
      
      
      //Tabs
      //uipanel_tabs_search.addEventListener("click",displaySearchPanel);
      //uipanel_tabs_nearby.addEventListener("click",displayNearPanel);
      uipanel_tabs_fromto.addEventListener("click", displayFromToPanel);
      uipanel_tabs_settings.addEventListener("click", displaySettingsPanel);

      // UI Mode: Search --> RouteListing
      function enterRouteListingMode(paths, timelimit,message){
        displayRouteListingPanel();
        
        cleanRouteList();
        
        uipanel_route_message.innerHTML=message;
        
        Log.debug("Listing "+paths.length+" paths.");
        paths.forEach(function(currentPath){
          //let currentPath=paths[i]; //we use let here so function closures don't fuck us over
          var newElement = document.importNode(routeTemplate.content, true);
          newElement.querySelectorAll(".route_name")[0].innerHTML=currentPath.name;
          newElement.querySelectorAll(".route_time")[0].innerHTML=Util.humanReadableTime(currentPath.timeRequired);
          
          var arrivalTimeDateObj=new Date(Date.now()+currentPath.timeRequiredInMillisec());
          var late=arrivalTimeDateObj.getTime()>timelimit;
          
          newElement.querySelector(".route_arrivaltime").innerHTML=Util.timeStampToFormattedTime(arrivalTimeDateObj.getTime());
          
          newElement.querySelector(".route_arrivaltime").classList.add((late?"arrival_late":"arrival_ontime"));
          newElement.querySelector(".route_icon").setAttribute("src",route_icon_path[currentPath.pref.time_name]);
          newElement.querySelector(".route_begin").addEventListener("click",function(){
            Log.info("begin navigation.");
            enterNavigationMode(currentPath, timelimit);
          });
          uipanel_route_list.appendChild(newElement);

          //somehow doing newElement.addEventListener does not work
          //don't ask me why
          var currentElement=uipanel_route_list.lastElementChild
          currentElement.addEventListener("mouseenter",function(){
            currentPath.displayOnMap(mymap);
          });

          currentElement.addEventListener("mouseleave",function(){
            currentPath.removeFromMap(mymap);
          });
        });
      }
      function enterNavigationMode(path, timelimit){
        Log.info("Navigation mode entered."+path.from.name+">>"+path.to.name+"["+path.pref.time_name+"]")
        
        var navContext=new NavigationContext(path);
          
        GPS.addLocationListener(function(location){
          navContext.updateLocation(location);
          if (!navContext.DEBUG_VARIABLE) Log.error("NULL???");
          //Log.debug("Debug Marker at\n"+navContext.DEBUG_VARIABLE.closestLocation.toString());
          debugMarker.setLatLng(navContext.DEBUG_VARIABLE.closestLocation.toLatLng());
        });
        displayNavigationPanel();
          
        var toPrint="Printing Path information\n";
        toPrint+="edge count: "+path.edges.length+"\n";
        for(var i=0;i<path.edges.length;i++){
          toPrint+="EDGE: "+path.edges[i].vStart.name+" >> "+path.edges[i].vEnd.name+"\n";
        }
        Log.verbose(toPrint);

        setTimeout(function(){//Avoid race condition with RouteListingPanel
          path.displayOnMap(mymap); 
        },100);


        navigation_routename.innerHTML=path.parray[0].v.name+" -> "+path.parray[path.parray.length - 1].v.name;
        navigation_targettime.innerHTML="목표도착시각: "+Util.timeStampToFormattedTime(timelimit);
        navigation_timeremaining.innerHTML="남은시간: ";
        navigation_eta.innerHTML="예상도착시간: ";
        
        navContext.addContextUpdateListener(function(data){
          navigation_timeremaining.innerHTML="남은시간: "+(data.timeLeft/1000).toFixed()+"sec.";
          navigation_eta.innerHTML="예상도착시간: "+Util.timeStampToFormattedTime(data.arrivalTime);
          displayProgessOnCanvas(data.routeCompletionRatio,
                                 route_icon_HTMLImageElement[path.pref.time_name]);
          
          if (new Date(Date.now()+data.timeLeft).getTime()>timelimit){
            navigation_eta.classList.remove("arrival_ontime");
            navigation_eta.classList.add("arrival_late");
          }else{
            navigation_eta.classList.remove("arrival_late");
            navigation_eta.classList.add("arrival_ontime");
          }
        });
        
          
          
        //TODO this is a memory leak!
        //All the objects are not actually released
        //and event listeners are not removed.
        //find a better solution.
        var exited=false;
        var exitNavigationMode=function(){
          if (exited) return;
          exited=true;
          navContext.deactivate();
          path.removeFromMap(mymap);
        }
        
        uiStateChangeListener.push(exitNavigationMode);
          
        //at first, assume user is in start position.
        navContext.updateLocation(path.from.coordinates);
      }



      
      fromto_button_importTT.addEventListener("click", function () {
          var nextLecture=timeTableData.nextLecture();
          if (nextLecture === null) {
            vin_to.setValue(Geodata.graph.vertices[0], "정문");
          }
          else {
            var n = nextLecture.location;
              vin_to.setValue(places[Util.getBuilding(n)], n);
              fromto_input_time.value=timeToString(nextLecture.startTime);
          }
          
          var lastLecture=timeTableData.lastLecture();
          if (lastLecture===null){
            vin_from.setValue(Geodata.graph.vertices[0], "정문");
          }
          else {
            var n = lastLecture.location;
            vin_from.setValue(places[Util.getBuilding(n)], n);
          }
          
      });

      var pref_walk_inside = { "time_name": "walk", "factors": [{ "condition": [{ "name": "inside", "value": false }], multiplier: 2 }] };

      fromto_button_find.addEventListener("click", function () {
        var fromName = vin_from.name;;
        var fromVertex = vin_from.value;
        var toName = vin_to.name;
        var toVertex = vin_to.value;

        var timeLimit = fromto_input_time.value;

        var timeLimitTimestamp = Util.colonSeparatedTimeToTimeStamp(timeLimit);


        if (!fromVertex) {
          Log.error("Invalid vertex name: \"" + fromName + "\" Cannot start navigation.")
          return;
        }
        if (!toVertex) {
          Log.error("Invalid vertex name: \"" + toName + "\" Cannot start navigation.")
          return;
        }

        search_query(fromVertex, toVertex, timeLimitTimestamp);
      });

      function search_query(fromVertex, toVertex, timeLimitTimestamp) {
        var path1 = new Path(Geodata.graph, fromVertex, toVertex, { "time_name": "walk" });
        path1.name = "걷기";
        var path2 = new Path(Geodata.graph, fromVertex, toVertex, { "time_name": "run" });
        path2.name = "뛰기";

        var path3 = new Path(Geodata.graph, fromVertex, toVertex, pref_walk_inside);
        path3.name = "실내통로 우선";

        var pathlist;
        var msg = "";
        if (Weather.getCompositeGrade() == "bad") {
          msg = "날씨 나쁨. 실내 통로 우선 탐색.";
          pathlist = [path3, path1];
        } else if (Weather.getCompositeGrade() == "okay") {
          msg = "날씨 좋지 않음. 실내 통로 표시.";
          pathlist = [path1, path2, path3];
        } else {
          pathlist = [path1, path2];
        }


        enterRouteListingMode(pathlist, timeLimitTimestamp, msg);
      }
      
      // 바꾸기 버튼
      fromto_button_swap.addEventListener("click", function () {
        var sv = vin_from.value, sn = vin_from.name;
        vin_from.setValue(vin_to.value, vin_to.name);
        vin_to.setValue(sv, sn);
      });

      //Debug Panel
      var debugpanel=document.getElementById("debugpanel");
      document.getElementById("debug_panel_toggle").addEventListener("click",function(){
        if (debugpanel.style.display==="none")debugpanel.style.display="flex";
        else debugpanel.style.display="none";
      });

      //debug buttons
      function debug_button_1_onclick(){
        Log.info("Entering fake location mode");
        GPS.stopTracking();
        mymap.on("click",function(e){
          e.latlng.alt=0; //e.latlng.alt==NaN for mouse clicks.          
          var location=Coordinates.fromLatLng(e.latlng);
          GPS.forceCurrentLocation(location);
        })

      }
      function debug_button_2_onclick(){
        Log.info("Override weather: Good weather");
        Weather.debug_override_weather(800,22,70);
      }
      function debug_button_3_onclick(){
        Log.info("Override weather: Okay weather");
        Weather.debug_override_weather(300,27,150);
      }
      function debug_button_4_onclick(){
        Log.info("Override weather: Bad weather");
        Weather.debug_override_weather(202,33,220);
      }
      function debug_button_5_onclick(){
        Log.error("Test Error");
      }
      function debug_button_6_onclick(){
        var d=new Date();
        d.setFullYear(2018);
        d.setMonth(05);
        d.setDate(04);
        d.setHours(12);
        d.setMinutes(55);
        d.setSeconds(00);
        timeTableData.debug_override_time=d;
        Log.info("Time overridden: 2018/06/04 12:55:00");
      }
      function debug_button_7_onclick(){
        var btn=document.getElementById("debug_panel_toggle");
        var panel=document.getElementById("debugpanel");
        
        btn.style.display="none";
        panel.style.display="none";
        
      }
      
      

    </script>
  </body>


</html>
